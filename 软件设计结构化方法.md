# 昆虫显微图像的生物量测量系统软件设计

## 1. 概述

### 1.1. 系统简介

本系统主要解决昆虫显微图像观测时生物量测量的问题。

系统旨在实现基于图像处理的中型昆虫生物量的自动检测系统，将现有新图像处理技术以及程序算法应用到系统中，测量中型土壤节肢动物的大小、体长。

系统总体的软件结构大致分为三层，三个模块：

首先，导入昆虫显微图片；其次，通过比例尺提取模块、体长标点计算模块、面积框选计算模块，分别得出显微图像的比例尺、观测昆虫的体长、观测昆虫的面积；最后，在在图片上或直接输出比例尺、生物量的数值，给予用户观测的结果。

### 1.2. 目标读者

本系统开发人员及指导老师

### 1.3. 书写约定

HLS、XYZ、Luv等缩写含义为各类灰度提取图片通道

OpenCV为计算机视觉库Open Source Computer Vision Libray的缩写

cv2.xxx函数基本上为图像处理函数

ROI为图像处理中矩形框选函数缩写

plotting_xxx等参数为比例尺相关参数

Bezier为一类曲线优化算法函数

## 2. 总体设计

使用软件层次图描述软件的总体架构如下，对于系统如此分解的依据为：

1.本系统实现的主要功能为：提取比例尺、计算观测生物的长度、计算观测生物的面积，最后整合输出数据，于是分为系统——整合模块——比例尺、长度、面积模块总的三层，而为了实现各自模块的功能，各模块下还有许多小模块以及模块下的其他层次。

2.比例尺模块中，识别图片需要输入图片路径参数，最后需要输出比例尺，于是有了输入图片路径&输出比例尺模块；对于不同图像，比例尺所在的位置不同，需要用户框选比例尺以应对不同图像的识别任务，于是有了画框、提取ROI、提取ROI内图像三个模块，这三个模块主要用于实现框选功能；比例尺的核心是识别比例尺后进行计算，于是就有了计算比例尺模块。

3.生物曲线拟合与长度测量模块中，我们需要在图像上手动打点绘出代表生物体长的折线再进行优化，最后输出绘画过的图片以及优化后曲线的长度，于是有了初始化模块、绘图模块、Bezier模块、main调用模块。

4.框选与测量生物面积模块中，我们需要框选观测的对象，对其进行图像分割后，识别观测的生物，并计算出其面积（所占像素点*比例尺）。为实现框选功能，于是有了画框、提取ROI、提取ROI内图像三个模块；识别图片需要输入图片路径参数，于是有了输入图片路径模块（这里图上画错了）；为了实现核心功能分割图像并识别，于是在提取ROI内图像模块下还有分割图像函数模块，提供分割识别生物图像、显示分割后的图像，计算输出生物面积的服务。

<img src="D:\图像处理_课程文件夹\软件工程\task-notification-master\task-notification-master\93.jpg" alt="93"  />

### 2.1. 整合输出数据模块

所使用的服务：接受比例尺模块、长度模块、面积模块传来的参数

所提供的服务：输出使用者需要的数据

### 2.2. 比例尺模块

所使用的服务：框选功能提供框选出的图像作为识别的image

所提供的服务：识别image内的比例尺，并输出

#### 2.2.1 提取（实时刷新）ROI模块

所使用的服务：调用函数获取当前鼠标状态和坐标

所提供的服务：返回当前框选的框的左上角坐标，框的长和宽；按下回车退出

#### 2.2.2画框模块

所使用的服务：接收提取（实时刷新）ROI模块传来的框的各个参数

所提供的服务：在图像上画出框

#### 2.2.3提取ROI内图像模块

所使用的服务：调用image_processing.py中的各类函数

所提供的服务：截取/显示框选区域内的图像

#### 2.2.4计算比例尺模块

所使用的服务：接受提取ROI内图像模块提取出的图像

所提供的服务：识别图像中的比例尺，返回比例尺长度

#### 2.2.5输入图片路径&输出比例尺（main)模块

所使用的服务：接受图片路径提取原图，调用函数接收比例尺数据

所提供的服务：打印输出比例尺结果

### 2.3生物曲线拟合与长度测量模块

所使用的服务：在图像上绘制生物体长曲线

所提供的服务：优化生物曲线并输出其身体长度

#### 2.3.1 绘图模块

所使用的服务：cv的各种绘制函数，鼠标的位置和操作参数

所提供的服务：在图像上打点绘制生物的身体曲线

#### 2.3.2 Bezier模块

所使用的服务：接受绘图模块绘制出的曲线的各参数

所提供的服务：优化曲线并计算曲线长度、打印曲线长度

#### 2.3.3 main调用模块

所使用的服务：无

所提供的服务：输出绘制后的图像

### 2.4框选与测量生物面积模块

所使用的服务：框选功能提供框选出的图像作为识别的image

所提供的服务：识别image内的生物，并输出生物面积

#### 2.4.1 提取（实时刷新）ROI模块

所使用的服务：调用函数获取当前鼠标状态和坐标

所提供的服务：返回当前框选的框的左上角坐标，框的长和宽；显示x通道图像；按下回车退出

#### 2.4.2画框模块

所使用的服务：接收提取（实时刷新）ROI模块传来的框的各个参数

所提供的服务：在图像上画出框

#### 2.4.3提取ROI内图像模块

所使用的服务：调用image_processing.py中的各类函数

所提供的服务：截取/显示框选区域内的图像

##### 2.4.3.1分割图像函数模块

所使用的服务：接受提取ROI内图像模块提取出的图像

所提供的服务：识别图像中的生物，显示分割后的图像，计算输出生物面积

#### 2.4.5输入图片路径&输出比例尺（main)模块

所使用的服务：接受图片路径提取原图

所提供的服务：运行程序

## 3. 详细设计

### 3.1. image_processing接口详细设计

```
①show_image(title, image)——调用matplotlib显示RGB图片——返回显示图片
```

```
②cv_show_image(title, image,flag)——显示图片函数——返回显示图片
```

```
③read_image(filename, resize_height=None, resize_width=None, normalization=False)——读取图像路径获取图像函数——返回（缩小的)图像
```

```
④resize_image(image, resize_height, resize_width)——缩小图像——返回缩放的图像
```

```
⑤get_rect_image(image, rect)——获取矩形框选的图像——返回矩形框选的图像
```

```
⑥scale_rect(orig_rect, orig_shape, dest_shape)——对矩形缩放回去——返回处理后的矩形数据
```

```
⑦show_image_rect(win_name, image, rect)——显示矩形框——返回绘制的矩形
```

```
⑧xsudian(image)——grabcut函数分割图像并计算前景（白色）像素点——返回识别的生物的像素点个数以及分割后的图像
```

### 3.2. 框选功能接口详细设计（包括画框模块、提取（实时刷新）ROI模块、提取ROI内图像模块）

```
①on_mouse(event, x, y, flags, param)——鼠标画框函数——返回绘制的矩形
```

```
②get_image_roi(rgb_image)——提取矩形区域（ROI）函数——返回当前选框，刷新当前选框
```

```
③select_user_roi(image_path)——提取矩形区域（ROI）图像的函数
```

### 3.3. 生物曲线拟合与长度测量模块详细设计

使用的算法：Bezier曲线公式转换

数据结构：

1.定义一个class类MyBezier	

```
class MyBezier
```

2.类中包含

```
__init__(self)
```

```
draw(self, event, x, y, flags, param)# 绘图
```

```
bezier(self, XVecs, YVecs) # Bezier曲线公式转换，获取x和y	
```

```
main(self)
```

等函数从而实现功能

### 3.4. 框选与比例尺模块详细设计

使用的算法：threshold

数据结构：

模块中包含

```
on_mouse(event, x, y, flags, param)鼠标画框函数——返回绘制的矩形
```

```
get_image_roi(rgb_image)提取矩形区域（ROI）函数——返回当前选框，刷新当前选框
```

```
select_user_roi(image_path)提取矩形区域（ROI）图像的函数
```

```
Jshow(img,title="")显示识别的比例尺图片的函数
```

```
calLength(img,thresh,rect,border,plotting_scaleLength)识别比例尺并返回比例尺长度的函数
```

等函数从而实现功能

### 3.5框选与测量生物面积模块详细设计

模块中包含

```
on_mouse(event, x, y, flags, param)鼠标画框函数——返回绘制的矩形
```

```
get_image_roi(rgb_image)提取矩形区域（ROI）函数——返回当前选框，刷新当前选框
```

```
select_user_roi(image_path)提取矩形区域（ROI）图像的函数
```

```
xsudian(image)grabcut函数分割图像并计算前景（白色）像素点
```

等函数从而实现功能

## 4. 数据设计

数据集为收集的各类昆虫显微图像，为输入数据，永久存储，存储在文件中。此数据的有效格式为jpg或png或tif

暂无对输出数据永久存储的要求。

## 5. 系统部署

*注：用UML部署图或者类似的框图来描述系统在硬件上的部署方案。*

![p3](D:\图像处理_课程文件夹\软件工程\task-notification-master\task-notification-master\p3.jpg)

## 6. 其它事项

*注：上述章节中未尽事宜可在此描述。*



